<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity4">
<head th:replace="fragment/head :: head"></head>
<body th:inline="text">
<div class="my-wrapper-body bghome panel-container">
    <p th:replace="fragment/header :: navbar"/>
    <div id="mySideBar" class="panel-left">
        <span id="position"></span>
        <p th:replace="fragment/sidebar :: left"/>
    </div>
    <div id="myDragBar" class="splitter"></div>
    <div id="myMain" class="panel-right">
        <div class="my-wrapper" id="my-wrapper">
            <div class="my-wrapper--inner">
                <div class="wrapper-content" id="general">
                    <div class="content--top border--bottom padding-content--left-right">
                        <div class="row">
                            <div class="col-md-12">
                                <h3 class="content--title text--bold">
                                    <i class="fas fa-edit"></i> Pasca Permohonan - Ubah
                                </h3>
                                <small class="sub-header">Pratinjau / Dokumen Lampiran</small>
                                <small style="float:right;margin-left:13px"><a th:href="@{/layanan/pratinjau-pasca-permohonan(no=${noGeneral})}"><i class="fa fa-arrow-left"></i> Kembali</a></small>
                            </div>
                        </div>
                    </div>
                    <div class="content--center padding-content--left-right">
                        <div class="wrapper--bg">
                            <div class="form form-horizontal">
                                <!-- <form class="form form-horizontal"> -->
<!--                                <input type="hidden" id="form1AppId" th:value="${noGeneral}"/>-->
<!--                                <input type="hidden" value="isEdit" id="isEdit"/>-->

                                <!--Header Judul-->
                                <div class="row col-md-12" style="margin-bottom: 15px">
                                    <div class="col-md-4">
                                        <h3>Data Lampiran</h3>
                                    </div>
                                    <div class="col-md-8">
                                        <div class="pull-right">
                                            <!-- <button type="button" class="btn btn-primary" id="btnSaveForm7"><i class="fas fa-save"></i>
                                                Simpan
                                            </button> -->
                                            <!-- <button type="button" class="btn btn-danger"
                                                    onclick="window.history.go(-1); return false;"><i class="fa fa-arrow-left"></i>
                                                Kembali
                                            </button> -->
                                        </div>
                                    </div>

                                </div>
                                <!--Form-->
                                <div class="row col-md-12">
                                    <div class="col-md-12">
                                        <div style="margin-bottom: 15px;">
                                            <a class="btn btn-info" id="btnAddDoc">
                                                <i class="fas fa-plus"></i>
                                                Tambah
                                            </a>
                                        </div>
                                        <div class="table-container">
                                            <table class="table table-striped table-bordered table-responsive" id="tableDoc">
                                                <thead>
                                                <tr>
                                                    <th></th>
                                                    <th></th>
                                                    <th>No.</th>
                                                    <th>Tanggal Upload</th>
                                                    <th>Jenis Dokumen</th>
                                                    <th>Nama File</th>
                                                    <th>Keterangan</th>
                                                    <th>Ukuran File</th>
                                                    <th></th>
                                                    <th></th>
                                                </tr>
                                                </thead>
                                                <tbody>
                                                </tbody>
                                            </table>
                                        </div>
                                        <!-- Modal -->
                                        <div class="modal fade" id="modalDoc" tabindex="-1" role="dialog" aria-labelledby="modalDoc">
                                            <div class="modal-dialog" role="document">
                                                <div class="modal-content">
                                                    <form id="formAddDoc">
                                                        <div class="modal-header">
                                                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                                <span aria-hidden="true">&times;</span></button>
                                                            <h4 class="modal-title" id="myModalLabel">Tambah Dokumen</h4>
                                                        </div>
                                                        <div class="modal-body">
                                                            <div class="form-group required">
                                                                <label class="col-sm-4 col-form-label required-label">Jenis Dokumen</label>
                                                                <div class="col-sm-8">
                                                                    <select class="form-control m-input required-input" id="docType" name="docType"
                                                                            required="required">
                                                                        <option style="display: none" value="">-Pilih Jenis Dokumen-</option>
                                                                        <option th:each="mDocType : ${listDocType}"
                                                                                th:value="${mDocType.id}"
                                                                                th:text="${mDocType.name}"></option>
                                                                    </select>

                                                                </div>
                                                            </div>
                                                            <div class="form-group">
                                                                <label class="col-sm-4 col-form-label">Keterangan</label>
                                                                <div class="col-sm-8">
                                                                    <textarea class="form-control" placeholder="Keterangan" id="docDesc" maxlength="500"/>
                                                                </div>
                                                            </div>
                                                            <div class="form-group required">
                                                                <label class="col-sm-4 col-form-label required-label">Upload File</label>
                                                                <div class="col-sm-8">
                                                                    <input type="file" class="btnUpload custom-file-input required-input"
                                                                           accept="application/pdf"
                                                                           id="docFile" name="docFile" required="required"/>
                                                                </div>
                                                            </div>

                                                        </div>
                                                        <div class="modal-footer">
                                                            <button type="button" class="btn btn-danger"
                                                                    data-dismiss="modal"><i class="fas fa-times"></i>
                                                                Batal
                                                            </button>
                                                            <button type="button" class="btn btn-primary" id="btnSaveDoc"><i class="fas fa-save"></i>
                                                                Simpan
                                                            </button>
                                                        </div>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                        <!-- End Modal -->
                                    </div>
                                </div>
                                <!-- </form> -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div><div th:replace="fragment/js :: default"></div>
<div th:replace="fragment/js :: main"></div>
<div th:replace="fragment/js :: datatables"></div>
<div th:replace="fragment/js :: datepickerEndDate"></div>
<script type="text/javascript" language="javascript" th:inline="javascript">
	/*<![CDATA[*/
	 $(document).ready(function () {
	     var urlViewDoc = /*[[@{/layanan/lihat-dokumen-lampiran-pasca-permohonan?id=}]]*/'';
		 var dataTableDokumen = $('#tableDoc').DataTable({
         	'createdRow': function( row, data, dataIndex ) {
      	      	$(row).attr('id', 'idDoc-'+data[1]);
    	    },
        	'columnDefs': [
        		{
                    'targets': [0,1,-1],
                    'visible': false
                },
        		{
                    'targets': 5,
                    'searchable': false,
	                'orderable': false,
                    'render': function ( data, type, full, meta ) {
	                	//return '<a href="'+full[8]+'" download="'+full[5]+'" class="downloads">'+full[5]+'</a>';
						var fileURL = full[9];
						if(fileURL.indexOf("application/pdf")!=-1){ //limit hanya pdf
							//convert to blob before download to support big file!!!
							var arr = fileURL.split(','), mime = 'application/pdf', bstr = atob(arr[1]), n = bstr.length, u8arr = new Uint8Array(n);
							while(n--){
								u8arr[n] = bstr.charCodeAt(n);
							}
							let newFile = new Blob([u8arr], {type:mime});
							fileURL = window.URL.createObjectURL(newFile);
						}
						return '<a target="_blank" href="'+fileURL+'" class="downloads">'+full[5]+'</a>';

					}
                },
                {
                    targets: -2,
                    width: '20px',
                    searchable: false,
                    orderable: false,
                    render: function ( data, type, full, meta ) {
                        return '<div>' +
                                    `<a style='margin-bottom: 8px;' href='${urlViewDoc}${full[0]}' class='btn btn-primary btn-xs'>Lihat</a>` +
                                    `<button onclick=deletePostDoc('${full[0]}') class='btn btn-danger btn-xs'>Hapus</button>` +
                               '</div>';
                    }
                }
            ],
            ajax: {
                type: 'GET',
                data: {
                    postId: /*[[${noGeneral}]]*/''
                },
                url: /*[[@{/layanan/cari-dokumen-pasca-permohonan}]]*/''

            },
        	language: {
                url: /*[[@{/js/i18n/datatables.in.json}]]*/''
            }
        });
		dataTableDokumen.on('error.dt',function(e,settings,techNote,message){
	        swal("Error", "Terjadi kesalahan pada aplikasi. Silakan muat ulang halaman ini.", "error");
        });

        $('#btnAddDoc').click(function () {
            $('.required-input').closest('.form-group').removeClass('has-error');
            $('.required-input').next().remove();
            $('#modalDoc').modal('show');
        });

        $('#docType').on("change", function(e) {
            if($('#docType').val() == 'TTDP' || $('#docType').val() == 'TTDK'  || $('#docType').val() == 'TTD') {
                $('#docFile').attr("accept","image/jpeg,image/jpg");
            } else {
                $('#docFile').attr("accept","application/pdf");
            }
        });

        $('#docFile').click(function (e) {
            if($('#docType').val() == '') {
                swal("Informasi", "Silahkan memilih Jenis Dokumen terlebih dahulu", "info");
                e.preventDefault();
            }
        });

        let files;
        let docFileName;
        let docFileType;
        let docFileSize;
        let docFileSrc;

        $('#docFile').change(function (event) {
            let error = '';
            files = event.target.files;
            docFileName = this.files[0].name;
            docFileType = this.files[0].type;
            docFileSize = this.files[0].size;

            <!--if (files[0].size > 15728640) {-->
                <!--error = 'Ukuran File Diatas 15 MB!';-->
            <!--}-->

            if ($('#docType').val() == 'TTDP' || $('#docType').val() == 'TTDK' || $('#docType').val() == 'TTD') {
                if (docFileType != 'image/jpeg') {
                    error = 'File yang dipilih bukan jpg/jpeg!';
                }
            } else if (docFileType != 'application/pdf') {
                error = 'File yang dipilih bukan pdf!';
            }

            if (error) {
                this.value = '';
                $('#docFile').closest('.form-group').addClass('has-error');
                $('#docFile').after('<span for="docFile" class="help-block">' + error + '</span>');
            }

            if (this.files[0]) {
                const reader = new FileReader();

                reader.onload = function(e) {
                    docFileSrc = e.target.result;
                }

                reader.readAsDataURL(this.files[0]);
            }
        });

        $('#btnSaveDoc').click(function () {
            const isValidForm = $("#formAddDoc").valid();

            if (isValidForm) {

                const docDate = /*[[${docUploadDate}]]*/'';
                const docId = $('#docType option:selected').val();
                const docType = $('#docType option:selected').text();
                const docDesc = $('#docDesc').val();

                if ($('#idDoc-' + docId).length == 0) {
                    $('#modalDoc').modal('hide');

                    let formData = new FormData;
                    const docList = [];
                    const items = {
                        docId,
                        docDate,
                        docType,
                        docDesc,
                        docFileName,
                        docFileSize
                    }

                    docList.push(items);

                    formData.append('file-' + docId, docFileSrc);

                    if (files) {
                        formData.append('docFiles', files[0]);
                    }

                    formData.append('postId', /*[[${noGeneral}]]*/'');
                    formData.append('txPostDocId', '');
                    formData.append('docList', JSON.stringify(docList));

                    $.ajax({
                        type: 'POST',
                        url: /*[[@{/layanan/update-data-download-dokumen-pasca"}]]*/'',
                        data: formData,
                        processData: false,
                        contentType: false,
                        cache: false,
                         beforeSend: function() {
                            showLoading();
                        },
                        complete: function() {
                            hideLoading();
                        },

                        success: function (data) {
                            var result = JSON.parse(data);
                            if(result.key === "fileTypeError") {
                                if (result.value === "notMatchFileTypeImage") {
                                    swal("Error", "Untuk file Jenis Dokumen Tanda Tangan harus JPG/JPEG.", "error");
                                } else if (result.value === "notMatchFileTypePdf") {
                                    swal("Error", "Untuk file Jenis Dokumen selain Tanda Tangan harus PDF.", "error");
                                }
                            }
                            else {
                                dataTableDokumen.ajax.reload();
                                $('#docType').val('');
                                $('#docDesc').val('');
                                $('#docFile').val('');
                            }
                            hideLoading();
                        },
                        error: function (xhr, status) {
                            swal("Error", "Terjadi kesalahan pada aplikasi. Silakan muat ulang halaman ini.", "error");
                        }
                    });
                } else {
                    swal("Informasi", "Data Jenis Dokumen '" + docType + "' Sudah Ada", "info");
                }
            }
        });
	 });
	 function deletePostDoc(postId) {
         swal("Konfirmasi", "Apakah Anda yakin akan menghapus data dokumen ini?", "warning", {buttons: { cancel:'Tidak', confirm:'Ya'}})
         .then(value => {
            if (value) {
                $.ajax({
                    type: 'POST',
                    url: /*[[@{/layanan/delete-dokumen-pasca-permohonan}]]*/'',
                    data: {
                        idDoc: postId
                    },
                    beforeSend: function() {
                        showLoading();
                    },
                    success: function() {
                        hideLoading();
                        $('#tableDoc').DataTable().ajax.reload();
                    },
                    error: function(xhr, status) {
                        swal("Error", "Terjadi kesalahan pada aplikasi. Silakan muat ulang halaman ini.", "error");
                    }
                });
            }
         });
     }
	/*]]>*/
</script>
</body>
</html>