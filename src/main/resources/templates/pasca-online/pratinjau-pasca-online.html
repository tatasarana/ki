<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity4">
<head th:replace="fragment/head :: head"></head>
<body th:inline="text">
<div class="my-wrapper-body bghome panel-container">
    <p th:replace="fragment/header :: navbar"/>
    <div id="mySideBar" class="panel-left">
		<span id="position"></span>
		<p th:replace="fragment/sidebar :: left"/>
	</div>
	<div id="myDragBar" class="splitter"></div>
	<div id="myMain" class="panel-right">
    <div class="my-wrapper" id="my-wrapper">
		<div class="my-wrapper--inner">
			<div class="wrapper-content">
				<div class="content--top border--bottom padding-content--left-right">
	            	<div class="row">
	                	<div class="col-md-12">
	                    	<h3 class="content--title text--bold">
	                      		<i class="fas fa-search"></i> Pasca Online - <span th:text="${dataGeneral.postNo}"></span>
	                     	</h3>
	                     	<small class="sub-header">Permohonan Merek / <a th:href="@{/layanan/list-pasca-online}">Pasca Online</a>
	                         / Pratinjau
	                    	</small>
	                     	<small style="float:right;margin-left:13px"><a th:href="@{/layanan/list-pasca-online}"><i class="fa fa-arrow-left"></i> Kembali</a></small>
	                     	<small style="float:right;margin-left:13px"><a th:if="${paramCetak}!=null" th:href="@{__'/layanan/download-dokumen/' + ${paramCetak}__}"><i class="fa fa-laptop"></i> Cetak Surat Perpanjangan</a></small>
	                     	
	            		</div>
	         		</div>
	        	</div>
	        	<div class="content--center padding-content--left-right">
	        		<div class="wrapper--bg">
	        			<div th:if="${errorMessage}" class="alert alert-danger alert-block fade in">
	                   		<button data-dismiss="alert" class="close close-sm" type="button">
	                       		<i class="icon-remove"></i>
	                   		</button>
	                   		<p>[[${errorMessage}]]</p>
	               		</div>
	               		<div class="panel-group">
	               			<ul class="nav nav-pills" role="tablist" style="margin-bottom: 15px">
	                        	<li class="nav-item active">
	                            	<a class="nav-link" data-toggle="tab" href="#panel1">
	                                	Data Pasca Online
	                            	</a>
	                        	</li>
		                	</ul>
		                	<div class="tab-content">
		                		<div class="tab-pane active" id="panel1" role="tabpanel">
		                			<!-- GENERAL -->
	                           		<div class="panel panel-primary">
	                                	<div class="panel-heading">
	                                    	General
	                                 	</div>
	                                 	<div class="panel-body">
	                                 		<div class="form form-horizontal">
	                                 			<div class="row" th:object="${dataGeneral}">
                                                	<div class="col-md-12">
                                                		<div class="col-md-6">
                                                			<div class="form-group">
	                                                            <label class="col-form-label col-sm-5">Nomor Transaksi</label>
	                                                            <div class="col-sm-7">
	                                                                <input type="text" class="form-control" disabled="disabled"
	                                                                       th:value="*{eFilingNo}"/>
	                                                            </div>
                                                        	</div>
                                                        	<div class="form-group">
	                                                            <label class="col-form-label col-sm-5">Nomor Dokumen</label>
	                                                            <div class="col-sm-7">
	                                                                <input type="text" class="form-control" disabled="disabled"
	                                                                       th:value="*{postNo}"/>
	                                                            </div>
                                                        	</div>
                                                        	
                                                			<div class="form-group">
	                                                            <label class="col-form-label col-sm-5">Tanggal Pengajuan</label>
	                                                            <div class="col-sm-7">
	                                                                <input type="text" class="form-control" disabled="disabled"
	                                                                       th:value="*{postDateTemp}"/>
	                                                            </div>
                                                        	</div>
                                                        	<div class="form-group">
	                                                            <label class="col-form-label col-sm-5">Asal Permohonan</label>
	                                                            <div class="col-sm-7">
																	<input type="text" class="form-control" disabled="disabled"
																		   th:value="*{mFileSequence == null ? '-' : mFileSequence.desc }"/>
	                                                            </div>
                                                        	</div>
                                                        	<div class="form-group"> 
	                                                        	<label class="col-form-label col-sm-5">Catatan</label>
	                                                            <div class="col-sm-7">
	                                                                <textarea class="form-control" disabled="disabled" th:text="*{note}" th:value="*{note}"> </textarea>
	                                                            </div>
	                                                        </div>
                                                		</div>
                                                		<div class="col-md-6">
                                                			<div class="form-group">
	                                                            <label class="col-form-label col-sm-5">Kode Billing</label>
	                                                            <div class="col-sm-7">
	                                                                <input type="text" class="form-control" disabled="disabled"
																		   th:value="*{billingCode == '' ? '-' : billingCode}"/>
	                                                            </div>
                                                        	</div>
                                                        	<div class="form-group">
	                                                            <label class="col-form-label col-sm-5">Tipe Permohonan</label>
	                                                            <div class="col-sm-7">
																	<input type="text" class="form-control" disabled="disabled"
																		   th:value="*{mFileType == null ? '-' : mFileType.desc}"/>
	                                                            </div>
	                                                        </div>
															<div class="form-group">
																<label class="col-form-label col-sm-5">Jenis Permohonan</label>
																<div class="col-sm-7">
																	<input type="text" class="form-control" disabled="disabled"
																		   th:value="*{mFileTypeDetail == null ? '-' : mFileTypeDetail.desc}"/>
																</div>
															</div>
	                                                        <div class="form-group">
	                                                            <label class="col-form-label col-sm-5">Tanggal Pembayaran</label>
	                                                            <div class="col-sm-7">
	                                                                <input type="text" class="form-control" disabled="disabled"
	                                                                       th:value="*{paymentDateTemp == null ? '-' : paymentDateTemp}"/>
	                                                            </div>
                                                        	</div>                                                        	 
	                                                        <div class="form-group">
	                                                            <label class="col-form-label col-sm-5">Jumlah Pembayaran</label>
	                                                            <div class="col-sm-7">
	                                                                <input type="text" class="form-control" disabled="disabled" th:value="*{totalPaymentTemp}"/>
	                                                            </div>
	                                                        </div>	                                                       
                                                        	<!--<div class="form-group">                                                        		-->
	                                                            <!--<label class="col-form-label col-sm-5">Username</label>-->
	                                                            <!--<div class="col-sm-7">-->
	                                                                <!--<input type="text" class="form-control" disabled="disabled"-->
	                                                                       <!--th:value="*{createdBy.username}"/>-->
	                                                            <!--</div>-->
	                                                        <!--</div>-->
                                                		</div>
                                                	</div>
                                                </div>
	                                 		</div>
	                            		</div>
	                            	</div>
	                            	<!-- DETAIL -->
	                           		<div class="panel panel-primary">
	                                	<div class="panel-heading">
	                                    	Referensi Permohonan
	                                 	</div>
	                                 	<div class="panel-body">
                                        	<div class="table-container">
               							 		<table class="table table-striped table-bordered table-responsive">
                   									<thead>
			                       						<tr>
			                       	    					<th hidden="true"></th>
			                            		 			<th>Nomor Permohonan</th>
			                            					<th>Merek</th>
			                            					<th>Nomor Registrasi</th>			  
			                            					<th>Status</th>			                            					
			                        					</tr>
                    								</thead>
                    								<tbody>
                    									<tr th:each="detailList : *{dataGeneralDetail}">
	                                                        <td th:text="${detailList.txTmGeneral.applicationNo}"></td>
	                                                        <td th:text="${detailList.txTmGeneral.txTmBrand == null ? '' : detailList.txTmGeneral.txTmBrand.name}"></td>
	                                                        <td th:text="${detailList.txTmGeneral.txRegistration == null ? '' : detailList.txTmGeneral.txRegistration.no}"></td>
	                                                        <td th:text="${detailList.txTmGeneral.mStatus.name}"></td>	                                                        
                                             			</tr>
                    								</tbody>
                    							</table>
                    						</div>
                    					</div>
	                              	</div>
	                            	
	                            	
	                            	<!-- PEMOHON -->
	                           		<div class="panel panel-primary">
	                                	<div class="panel-heading">
	                                    	Pemohon
	                                 	</div>
	                                 	<div class="panel-body">
                                            <div class="table-container">
                                                <table class="table table-striped table-bordered table-responsive">
                                                    <thead>
                                                    <tr>
                                                        <td>Nama Pemohon</td>
                                                        <td>Alamat</td>
                                                        <td>Telepon</td>
														<td>Email</td>
                                                        <td>Negara</td>
                                                    </tr>
                                                    </thead>
                                                    <tbody th:object="${dataPemohon}">
                                                    <tr>
                                                        <td th:text="*{name}"></td>
                                                        <td th:text="*{address}"></td>
                                                        <td th:text="*{phone}"></td>
														<td th:text="*{email}"></td>
                                                        <td th:text="*{mCountry.name}"></td>
                                                    </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
	                           		</div>
	                           		<!-- KUASA -->
	                           		<div class="panel panel-primary">
	                                	<div class="panel-heading">
	                                    	Kuasa
	                                 	</div>
	                                 	<div class="panel-body">
                                            <div class="table-container">
                                                <table class="table table-striped table-bordered table-responsive">
                                                    <thead>
                                                    <tr>
                                                        <td>Nomor Konsultan</td>
                                                        <td>Nama Konsultan</td>
                                                        <td>Alamat</td>
                                                        <td>Telepon</td>
														<td>Email</td>
                                                    </tr>
                                                    </thead>
                                                    <tbody th:object="${dataKuasa}">
                                                    <tr>
                                                        <td th:text="*{mRepresentative.no}"></td>
                                                        <td th:text="*{mRepresentative.name}"></td>
                                                        <td th:text="*{mRepresentative.address}"></td>
                                                        <td th:text="*{mRepresentative.phone}"></td>
														<td th:text="*{mRepresentative.email}"></td>
                                                    </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
	                              	</div>
	                              	<!-- DOKUMEN -->
	                           		<div class="panel panel-primary">
	                                	<div class="panel-heading">
	                                    	Dokumen Lampiran
                                            <!--<a class="btn btn-xs btn-default pull-right" id="btnAddDoc">-->
                                                <!--<i class="fas fa-default"></i>Tambah</a>-->
	                                 	</div>                                        
	                                 	<div class="panel-body">
                                        	<div class="table-container">
               							 		<table class="table table-striped table-bordered table-responsive" id="tableDokumen">
                   									<thead>
			                       						<tr>
			                       	    					<th></th>
			                       	    					<th>No</th>
			                            		 			<th>Tanggal Upload</th>
			                            					<th>Jenis Dokumen</th>
			                            					<th>Nama File</th>
			                            					<th>Keterangan</th>
			                            					<th>Ukuran File</th>
			                            					<th></th>
			                        					</tr>
                    								</thead>
                    							</table>
                    						</div>
                    					</div>
	                              	</div>
		                		</div>
		                	</div>
	               		</div>
	        		</div>
	        	</div>
			</div>
		</div>
	</div>
</div>
<!-- Modal -->
<div class="modal fade" id="modalDoc" tabindex="-1" role="dialog" aria-labelledby="modalDoc">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <form id="formAddDoc" class="form-horizontal form--input">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"
                            aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                    <h4 class="modal-title" id="myModalLabel">Tambah Dokumen</h4>
                </div>
                <div class="modal-body">
                    <div class="form-group required">
                        <label class="col-sm-4 col-form-label">Jenis Dokumen</label>
                        <div class="col-sm-8">
                            <select class="form-control m-input required-input"
                                    id="docType" name="docType" required="required">
                                <option style="display: none" value="">-Pilih Jenis Dokumen-</option>
                                <option th:each="item : ${listDocType}"
                                        th:value="${item.mDocType.id}"
                                        th:text="${item.mDocType.name}"></option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-4 col-form-label">Keterangan</label>
                        <div class="col-sm-8">
                            <textarea class="form-control" placeholder="Keterangan" id="docDesc" maxlength="500" />
                        </div>
                    </div>
                    <div class="form-group required">
						<div class="col-sm-4">
							<label>Upload File</label>
							<br/>
							<span style="color: red;font-size:12px">(Format File : Hanya PDF)</span>
						</div>
                        <div class="col-sm-8">
                            <input type="file"
                                   class="btnUpload custom-file-input required-input"
                                   accept="application/pdf" id="docFile" name="docFile"
                                   required="required" />
                        </div>
                    </div>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default"
                            data-dismiss="modal"><i class="fas fa-times"></i> Batal</button>
                    <button type="button" class="btn btn-primary"
                            id="btnSaveDoc"><i class="fas fa-save"></i> Simpan</button>
                </div>
            </form>
        </div>
    </div>
</div>
<!-- End Modal -->
</div><div th:replace="fragment/js :: default"></div>
<div th:replace="fragment/js :: datatables"></div>
<div th:replace="fragment/js :: main"></div>
<script type="text/javascript" language="javascript" th:inline="javascript">
	/*<![CDATA[*/
	$(document).ready(function () {
		var csrf = /*[[${_csrf.token}]]*/'';
		var header = "X-CSRF-TOKEN";
        $(document).ajaxSend(function (e, xhr, options) {
            xhr.setRequestHeader(header, csrf);
        });
        
        var docUploadDate = /*[[${docUploadDate}]]*/'';
		var dataTableDokumen = $('#tableDokumen').DataTable({
        	'createdRow': function( row, data, dataIndex ) {
      	      	$(row).attr('id', 'doc-'+data[0]);
    	    },
        	'columnDefs': [
        		{
                    'targets': [0,-1],
                    'visible': false
                },
        		{
                    'targets': 4,
                    'searchable': false,
	                'orderable': false,
                    'render': function ( data, type, full, meta ) {
                    	var fileURL = full[7]
                    	if(full[7].indexOf("application/pdf")!=-1){ //limit hanya pdf
							//convert to blob before download to support big file!!!
							var arr = full[7].split(','), mime = 'application/pdf', bstr = atob(arr[1]), n = bstr.length, u8arr = new Uint8Array(n);
							while(n--){
								u8arr[n] = bstr.charCodeAt(n);
							}
							let newFile = new Blob([u8arr], {type:mime});
							fileURL = window.URL.createObjectURL(newFile);
						}
	                	return '<a href="'+fileURL+'" download="'+full[4]+'">'+full[4]+'</a>';
	                }
                }
            ],
            ajax: {
                type: 'GET',
                data: {
                    postId: /*[[${dataGeneral.id}]]*/''
                },
                url: /*[[@{/layanan/cari-dokumen-pasca-online}]]*/''

            },
        	language: {
                url: /*[[@{/js/i18n/datatables.in.json}]]*/''
            }
        });
		dataTableDokumen.on('error.dt',function(e,settings,techNote,message){
	        swal("Error", "Terjadi kesalahan pada aplikasi. Silakan muat ulang halaman ini.", "error");
        });
		
		$("#formAddDoc").validate({
            messages: {
                "docType": {
                    required: /*[[#{field.error.required('Jenis Dokumen')}]]*/''
                },
                "docFile": {
                    required: /*[[#{field.error.required('File Dokumen')}]]*/''
                }
            },
            highlight: function (element) {
                $(element).closest('.form-group').addClass('has-error');
            },
            unhighlight: function (element) {
                $(element).closest('.form-group').removeClass('has-error');
            },
            errorElement: 'span',
            errorClass: 'help-block',
            errorPlacement: function (error, element) {
                if (element.parent('.input-group').length) {
                    error.insertAfter(element.parent());
                } else {
                    error.insertAfter(element);
                }
       		}
        });
		
		$('#btnAddDoc').click(function () {
        	$('#docType').val('');
        	$('#docDesc').val('');
        	$('#docFile').val('');
        	
        	$('.required-input').closest('.form-group').removeClass('has-error');
        	$('.required-input').next().remove();
        	
        	$('#modalDoc').modal('show');
        });
		
		var docFileName;
        var docFileType;
        var docFileSize;
        var docFileSrc;
        
        $('#docFile').change(function () {
        	var error = '';
        	docFileName = this.files[0].name;
        	docFileType = this.files[0].type;
        	docFileSize = this.files[0].size;
    
        	$('#docFile').closest('.form-group').removeClass('has-error');
        	$('#docFile').next().remove();
        	
        	/*if (docFileSize > 15728640) {
        		error = 'Ukuran File Diatas 15 MB!';
                this.value = "";
            } */
        	if (docFileType != 'application/pdf') {
        		error = 'File yang dipilih bukan pdf!';
                this.value = "";
            } 
        	if(error.length > 0){
        		$('#docFile').closest('.form-group').addClass('has-error');
            	$('#docFile').after('<span for="docFile" class="help-block">' + error + '</span>');
        	}
        	if (this.files[0]) {
        		var reader = new FileReader();

                reader.onload = function(e) {
                	docFileSrc = e.target.result;
                }

                reader.readAsDataURL(this.files[0]);
        	}
        });
        
        $('#btnSaveDoc').click(function () {
        	var isValidForm = $("#formAddDoc").valid();
        	
        	if(isValidForm){
        		var dt = docUploadDate;
        		var docId = $('#docType option:selected').val();
        		var docType = $('#docType option:selected').text();
        		var docDesc = $('#docDesc').val();
        		
        		//if ($("#doc-"+docId).length == 0) {
        			dataTableDokumen
					.row.add( [ docId, 0, dt, docType, docFileName, (docDesc=="null"?"":docDesc), docFileSize, docFileSrc ] )
         			.draw()
         			.node();
                	
        			dataTableDokumen.column(1).nodes().each( function (cell, i) {
		        		cell.innerHTML = i + 1;
		            });
            		
        			$('#modalDoc').modal('hide');
        			
        			var formData = new FormData;
        			var docList = [];
        			
	          	        var item = {}
	            	
	          	        item ["docId"] = docId;
	                    item ["docDate"] = dt;
	                    item ["docType"] = docType;
	                    item ["docFileName"] = docFileName;
	                    item ["docDesc"] = (docDesc==null?"":docDesc);
	                    item ["docFileSize"] = docFileSize;
	                    
	                    docList.push(item);
	                    formData.append('file-'+docId, docFileSrc);
	                    
					var postId = /*[[${dataGeneral.id}]]*/'';
					formData.append('postId', postId);
					formData.append('docList', JSON.stringify(docList));
	            	    	
    	            $.ajax({
    	                type: 'POST',
    	                url: /*[[@{/layanan/save-pratinjau-dokumen-pasca-online"}]]*/'',
    	                data: formData,
    	                processData: false,
    	                contentType: false,
    	                cache: false,
    	                beforeSend: function () {
    	                	showLoading();
    	                },
    	                complete:function(){
    	                	hideLoading();
    	                },
    	                success: function (data) {
    	               	},
		                error: function (xhr, status) {
			                swal("Error", "Penambahan dokumen pdf gagal. Periksa kembali file pdf Anda.", "error");
		                }
    	            });
        		/*} else {
        			swal("Informasi", "Data Jenis Dokumen '" + docType + "' Sudah Ada", "info");
        		}*/
        	}
        });
	 }); 
	/*]]>*/
</script>
</body>
</html>
